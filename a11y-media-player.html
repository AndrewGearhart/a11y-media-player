<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../responsive-utility/responsive-utility.html">
<link rel="import" href="../juicy-html/juicy-html.html">
<link rel="import" href="screenfull-lib.html">
<link rel="import" href="a11y-media-play-button.html">
<link rel="import" href="a11y-media-number-input.html">
<link rel="import" href="a11y-media-button.html">

<!--
`a11y-media-player`
A LRN element

@demo demo/index.html

@microcopy - the mental model for this element
 -
 -
 -

-->

<dom-module id="a11y-media-player">
  <template>
    <style>
      :host {
        display: block;
        max-width: 100%;
      }
      :host[responsive-size="xs"] *[hidden-when*="xs"],
      :host[responsive-size="sm"] *[hidden-when*="sm"],
      :host[responsive-size="md"] *[hidden-when*="md"],
      :host[responsive-size="lg"] *[hidden-when*="lg"],
      :host[responsive-size="xl"] *[hidden-when*="xl"] {
        display: none;
      }
      :host #controls, 
      :host #slider, 
      :host #mediaobject,
      :host #mediaobject > * {
        width: 100%;
      }
      :host #media {
        z-index: 1;
      }
      :host #player {
        background-color: black;
      }
      :host #mediaobject {
        padding-top: 56.25%;
        position: relative;
      }
      :host #video {
        position: absolute;
        top: 0;
        left: 0;
      }
      :host #playbutton {
        padding-top: 56.25%;
        opacity: 1;
        -webkit-transition: opacity 0.5s;
        -moz-transition: opacity 0.5s;
        transition: opacity 0.5s;
      }
      :host #playbutton[disabled], 
      :host[playing] #playbutton {
        opacity: 0;
      }
      :host .status {
        font-size: 85%;
        padding: 8px 13px 8px;
      }
      :host .status, 
      :host paper-icon-button {
        border: none;
        background-color: black;
        color: #bbb;
        position: relative;
      }
      :host .section {
        position: relative;
        height: 40px;
      }
      :host .section > * {
        position: absolute;
      }
      :host .show-volume {
        display: inline;
      }
      :host .show-volume #volume {
        z-index: 1;
        position: absolute;
        left: 100%;
        top: 4px;
        width: 0;
        overflow: hidden;
        transition: width 1s;
      }
      :host .show-volume:active #volume,
      :host .show-volume:focus #volume,
      :host .show-volume:hover #volume {
        overflow: visible;
        width: 100px;
      }
      :host paper-menu-button {
        padding: 0;
      }
      :host .section > .section-left {
        left: 0;
      }
      :host .section > .section-right {
        right: 0;
      }
      :host paper-icon-button:active,
      :host paper-icon-button:focus,
      :host paper-icon-button:hover {
        color: #fff;
      }
      :host paper-listbox {
        padding: 0;
      }
      :host paper-item, 
      :host paper-listbox {
        color: white;
        background-color: black;
      }
      :host paper-item {
        min-height: 40;
      }
      :host paper-toggle-button {
        --paper-toggle-button-unchecked-bar-color:  #eeeeee;
        --paper-toggle-button-unchecked-button-color:  #f8f8f8;
        --paper-toggle-button-checked-bar-color:  #00fffd;
        --paper-toggle-button-checked-button-color:  #00eeff;
      }
      :host paper-slider {
        z-index: 3;
        --paper-slider-knob-start-border-color: transparent;
        --paper-slider-knob-end-border-color: transparent;
        --paper-slider-active-color: #00fffd;
        --paper-slider-secondary-color: #4E7373;
        --paper-slider-pin-color: #444;
        --paper-slider-pin-start-color: #444;
        --paper-slider-knob-color: #00eeff;
        --paper-slider-knob-start-color: #eeeeee;
        --paper-slider-knob-end-color: #00eeff;
      }
      :host paper-item .menu-text {
        width: 120px;
      }
      :host paper-item .menu-text2 {
        width: 60px;
      }
      :host paper-item paper-slider {
        width: 110px;
      }
    </style>
    <div id="empty"></div>
    <div id="player">
      <div id="media">
        <div id="mediaobject">
          <video 
            autoplay$="[[autoplay]]" 
            id="video" 
            loop$="[[loop]]" 
            muted$="[[muted]]" 
            preload="metadata">
            <slot></slot>
            HTML5 video not supported 
          </video>
          <a11y-media-play-button id="playbutton"></a11y-media-play-button>
        </div>
      </div>
      <paper-slider id="slider" max$="[[duration]]" pin secondary-progress$="[[buffered]]" tab-index="-1" value$="[[elapsed]]"></paper-slider>
      <div id="controls">
        <responsive-utility id="utility" responsive-to-parent="true"></responsive-utility>
        <div class="section">
          <div class="section-left">
            <a11y-media-button hidden-when="xs" icon="av:fast-rewind" label="backward"></a11y-media-button>
            <a11y-media-button icon="[[playPause.icon]]" label="[[playPause.label]]"></a11y-media-button>
            <a11y-media-button hidden-when="xs" icon="av:fast-forward" label="forward"></a11y-media-button>
            <a11y-media-button hidden-when="xs" icon="av:replay" label="restart"></a11y-media-button>
            <div class="show-volume">
              <a11y-media-button icon="[[muteUnmute.icon]]" label="[[muteUnmute.label]]"></a11y-media-button>
              <paper-slider id="volume" min="0" max="100" pin step="10" tab-index="-1" value$="[[volume]]"></paper-slider>
            </div>
            <span class="status" hidden-when="xs"><juicy-html html$="[[__length]]"></juicy-html></span>
          </div>
          <div class="section-right">
            <a11y-media-button icon="av:closed-caption" label="closed captions" toggle$="[[cc]]"></a11y-media-button>
            <paper-menu-button id="settings" vertical-align="bottom" ignore-select>
              <paper-icon-button icon="settings" slot="dropdown-trigger" alt="Settings"></paper-icon-button>
              <paper-listbox slot="dropdown-content">
                <paper-item>
                  <div class="menu-text">Autoplay </div>
                  <paper-toggle-button id="autoplay" checked$="[[autoplay]]"></paper-toggle-button>
                </paper-item>
                <paper-item>
                  <div class="menu-text">Loop </div>
                  <paper-toggle-button id="loop" checked$="[[loop]]"></paper-toggle-button></paper-item>
                <paper-item>
                  <div class="menu-text">Captions </div>
                  <paper-toggle-button id="captions" checked$="[[cc]]"></paper-toggle-button>
                </paper-item>
                <paper-item>
                  <div class="menu-text2">Speed </div>
                  <paper-slider id="speed" min="50" max="400" pin step="50" tab-index="-1" value$="[[playbackRate]]"></paper-slider>
                </paper-item>
              </paper-listbox>
            </paper-menu-button>
            <paper-tooltip for="settings">settings</paper-tooltip>
            <a11y-media-button icon="fullscreen" label="full screen" toggle$="[[fullscreen]]" step="1"></a11y-media-button>
          </div>
        </div>
      </div>
    </div>
    <div class="status" hidden-when="sm md lg xl"><juicy-html html$="[[__length]]"></juicy-html></div>
    <iron-a11y-keys id="a11y" keys="up right" target$="[[__slider]]"
    on-keys-pressed="forward"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" keys="down left" target$="[[__slider]]"
    on-keys-pressed="rewind"></iron-a11y-keys>
  </template>

  <script>
    Polymer({

      is: 'a11y-media-player',

      listeners: {
        'play-button-clicked': 'play',
        'button-clicked': '_onButtonClick',
        'change': '_onSettingsChanged',
        'screen-resize': '_onResponsiveResize'
      },

      properties: {
        /* 
         * fullscreen option 
         */
        allowFullscreen: {
          type: Boolean,
          value: true,
        },
        /* autoplay is an option, 
         * but generally not recommended for a11y
         */ 
        autoplay: {
          type: Boolean,
          value: false,
        },
        /*
         * buffered video in seconds
         */
        buffered: {
          type: Number,
          value: 0,
        },
        /*
         * show closed captions
         */
        cc: {
          type: Boolean,
          value: false,
        },
        /*
         * duration of video in seconds
         */
        duration: {
          type: Number,
          value: 0,
        },
        /*
         * elapsed time in seconds
         */
        elapsed: {
          type: Number,
          value: 0,
        },
        /* 
         * is fullscreen mode
         */
        fullscreen: {
          type: Boolean,
          value: false,
        },
        /* 
         * The width of the media player. */
        height: {
          type: String,
          value: 'unset'
        },
        /*
         * language
         */
        lang: {
          type: String,
          value: 'en',
          reflectToAttribute: true,
        },
        /*
         * length of video
         */
        length: {
          type: String,
          value: '',
        },
        /* 
         * looping is not fully supported
         */
        loop: {
          type: Boolean,
          value: false,
        },
        /* 
         * is audio muted
         */
        muted: {
          type: Boolean,
          value: false,
        },
        /*
         * size of the media element for responsive styleing
         */
        responsiveSize: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },
        /*
         * is media playing
         */
        playing: {
          type: String,
          value: false,
          reflectToAttribute: true
        },
        /*
         * playback rate where 1 is normal speed, 0.5 is half-speed, and 2 is double speed
         */
        playbackRate: {
          type: Number,
          value: 100
        },
        /*
         * play/pause button
         */
        playPause: {
          type: Object,
          computed: '_getPlayPause(playing)'
        },
        /*
         * mute/unmute button
         */
        muteUnmute: {
          type: Object,
          computed: '_getMuteUnmute(muted)'
        },
        /*
         * selected track
         */
        track: {
          type: Object,
          value: null,
        },
        /* 
         * Range is 0 to 100. Default should not be loud enough to overpower screen readers. */
        volume: {
          type: Number,
          value: 70,
        },
        /* 
         * The width of the media player. */
        width: {
          type: String,
          value: 'unset'
        },
      },
      ready: function(){
        let root = this, video = this.$.video;
        root.__slider = root.$.slider;
        root.__resumePlaying = false;
        root.__showFullscreen = this.allowFullscreen && screenfull.enabled;
        root.__length = 'Loading...';
        if(root.__showFullscreen) {
          screenfull.on('change', () => { this.fullscreen = screenfull.isFullscreen });
        }
        //hide the video subtitles and captions
        root.track = video.textTracks.length > 0 ? video.textTracks[0] : null;
        for(i in video.textTracks) {
          if (video.textTracks[i] !== null) video.textTracks[i].mode = 'hidden';
        }
        //handle dragging with a mouse
        //when dragging stops, seek to that value and if the video was playing before the dragging, resume it
        root.$.slider.addEventListener('dragging-changed', (e) => {
          if (!root.$.slider.dragging) { 
            root.seek(root.$.slider.immediateValue);
            if (root.__resumePlaying) root.play();
            root.__resumePlaying = false;
          }
        });
        root.$.settings.addEventListener('iron-activate', (e) => {
          e.preventDefault();
          console.log('activated');
        });
        root.$.settings.addEventListener('iron-select', (e) => {
          e.preventDefault();
          console.log('selected');
        });
        //handle slider focus
        //temporarily pause playback so that a value can be selected, but note if playing should be resumed
        root.$.slider.addEventListener('focused-changed', (e) => {
          console.log('focused-changed',root.$.slider.focused,'drag',root.$.slider.dragging,'resume',root.__resumePlaying);
          if(root.$.slider.focused){
            if (root.playing) root.__resumePlaying = true;
            root.pause();
          } else {
            root.seek(root.$.slider.value);
            if (root.__resumePlaying) root.play();
            root.__resumePlaying = false;
          }
        });
        //adjust video width and height based on attributes
        if (root.width === 'unset' && root.height === 'unset'){
          root.style.width = '100%';  
        } else if (root.width === 'unset' && root.height !== 'unset') {
          root.style.height = root.height;
        } else {
          root.style.width = root.width;  
        }
        //get and convert video duration & adjust aspect ration based on loaded metadata
        root.$.video.addEventListener('loadedmetadata',function(){
          if (root.width !== 'unset') root.setAttribute('width',root.width);
          if (root.height !== 'unset') root.setAttribute('width',root.height);
          let aspect = root.$.video.videoHeight/root.$.video.videoWidth * 100;
          root.duration = video.duration > 0 ? video.duration: 0; 
          root.__length = root._convertTime(0)+'/'+root._convertTime(video.duration);
          root.$.playbutton.style.paddingTop = aspect+'%';
          root.$.mediaobject.style.paddingTop = aspect+'%';
        });
      },
      /* 
       * plays the media 
       */
      play: function(e){
        let root = this, video = root.$.video;
        if (e === undefined || e.detail === root.$.playbutton) {
          root.$.playbutton.setAttribute('disabled',true);
          root.playing = true;
          // while playing, update the slider and length
          root.__playProgress = setInterval(() => {
            root.elapsed = video.currentTime > 0 ? video.currentTime : 0;
            root.__length = root._convertTime(video.currentTime,video.duration) +'/'+ root._convertTime(video.duration);
            // if the video reaches the end and is not set to loop, stop
            if(root.elapsed == root.duration && !root.loop){
              root.$.playbutton.removeAttribute('disabled');
              root.playing = false;
              clearInterval(root.__playProgress);
            }
            //updated buffered section of the slider
            root.buffered = video.buffered.length > 0 ? video.buffered.end(0) : root.elapsed;
          }, 1);

          root.$.video.play();
        }
      },
      /* 
       * pauses the media 
       */
      pause: function(e){
        let root = this;
        root.playing = false;
        root.$.video.pause();
        clearInterval(root.__playProgress); //stops updating the slider and length
      },
      /* 
       * seeks media backward at a set increment
       */
      rewind: function(amt){
        amt = amt !== undefined ? amt : 1;
        this.seek(Math.max(this.$.video.currentTime - amt,0));
      },
      /* 
       * seeks media forward at a set increment
       */
      forward: function(amt){
        amt = amt !== undefined ? amt : 1;
        this.seek(Math.min(this.$.video.currentTime + amt,this.$.video.duration));
      },
      /* 
       * seek to a specific time 
       */
      seek: function(time){
        let seekable = this.$.video.seekable;
        if (seekable.length > 0 && time >= seekable.start(0) && time <= seekable.end(0)) {
          this.$.video.currentTime = time;
        }
      },
      /* 
       * toggles captions:
       * toggleCC(true) to check the toggle, toggleCC(false) for unchecking, and toggleCC to toggle  
       */
      toggleCC: function(mode){
        mode = mode === undefined ? !this.cc : mode;
        console.log(this.track);
        this.cc = mode;
        this.track.mode = mode ? 'showing' : 'hidden';
      },
      /* 
       * toggles mute:
       * toggleMute(true) to check the toggle, toggleMute(false) for unchecking, and toggleMute to toggle  
       */
      toggleMute: function(mode){
        mode = mode === undefined ? !this.muted : mode;
        this.muted = mode;
        this.$.volume.value = this.muted ? 0 : Math.max(this.volume,10);
        this.$.video.volume = this.muted ? 0 : Math.max(this.volume/100,0.1);
        this.$.video.muted = this.muted;
      },
      /* 
       * toggles looping:
       * toggleLoop(true) to check the toggle, toggleLoop(false) for unchecking, and toggleLoop to toggle  
       */
      toggleLoop: function(mode){
        mode = mode === undefined ? !this.loop : mode;
        this.loop = mode;
        this.$.video.muted = this.loop;
      },
      /**
       * sets size class based on parent container and breakpoints
       */ 
      _onResponsiveResize: function(e){
        this.responsiveSize = e.detail.screen;
      },
      /* set play/pause button */
      _convertTime: function(val,max){
        max = max === undefined ? val : max;
        let a = (val) => { return val < 10 ? '0' + val : val; }, 
        b = (val,i) => { return Math.floor(max/i) > 0 ? a(Math.floor(val/i)) : '00' },
        c = (val) => { return Math.floor(max/3600) > 0 ? a(Math.round(val)) : a(Math.floor(val))+'.'+a(Math.round(val*10)) };
        return b(val,3600)+':'+b(val%3600,60)+':'+c(val%60);
      },
      /* set play/pause button */
      _getPlayPause: function(playing){
        return playing ? {'icon': 'av:pause', 'label': 'pause'} : {'icon': 'av:play-arrow', 'label': 'play'};
      },
      /* set play/pause button */
      _getMuteUnmute: function(muted){
        return muted ? {'icon': 'av:volume-off', 'label': 'unmute'} : {'icon': 'av:volume-up', 'label': 'mute'};
      },
      /* seeks to slider position when slider is dragged */
      _onSliderChange: function(slider){
        this.seek(slider.value);
      },
      /* resume updating value via playback */
      _onDraggingChange: function(root){
        if(root.$.slider.dragging){
          root.$.slider.addEventListener('value-changed',root._onSliderChange(root.$.slider));
        } else {
          this.seek(e.target.value);
          root.$.slider.removeEventListener('value-changed',root._onSliderChange(root.$.slider));
        }
        this.__dragging = root.$.slider.dragging; 
      },
      /* determine which button was clicked and act accordingly */
      _onButtonClick: function(e){
        if (e.detail.label === 'backward') {
          this.rewind(this.$.video.duration/20);
        } else if (e.detail.label === 'closed captions') {
          this.toggleCC();
        } else if (e.detail.label === 'forward') {
          this.forward(this.$.video.duration/20);
        } else if (e.detail.label === 'full screen') {
          screenfull.toggle(this);
        } else if (e.detail.label === 'loop') {
          this.toggleLoop();
        } else if (e.detail.label === 'mute' || e.detail.label === 'unmute') {
          this.toggleMute();
        } else if (e.detail.label === 'pause') {
          this.pause();
        } else if (e.detail.label === 'play') {
          this.play();
        } else if (e.detail.label === 'restart') {
          this.seek(0);
          this.play();
        }
      },
      /* determine which button was clicked and act accordingly */
      _onSettingsChanged: function(e){
        console.log('settings');
        if (e.target === this.$.autoplay) {
          this.$.video.autoplay = e.target.checked;
        } else if (e.target === this.$.captions) { //todo
          this.toggleCC();
        } else if (e.target === this.$.loop) {
          this.toggleLoop();
        } else if (e.target === this.$.volume) {
          this.volume = this.$.volume.value !== null ? this.$.volume.value : 70;
          this.$.video.volume = this.volume !== null ? this.volume/100 : 0.7;
          this.muted = this.$.volume.value !== null && this.$.volume.value === 0;
        } else if (e.target === this.$.speed) {
          this.$.video.playbackRate = e.target.value !== null ? e.target.value/100 : 1;
        }
      }
    });
  </script>
</dom-module>
