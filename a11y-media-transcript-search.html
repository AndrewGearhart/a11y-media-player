<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-input/paper-input.html">

<!--
`a11y-media-transcript-search`
A button used in a11y-media-controls

@demo demo/index.html

@microcopy - the mental model for this element
 -
 -
 -

-->

<dom-module id="a11y-media-transcript-search">
  <template>
    <style is="custom-style">
      :host #input {
        background-color: var(--simple-search-bg-color, #ffffff);
        --paper-input-container-input-color: var(--simple-search-text-color, #000000);
        --paper-input-container-focus-color: var(--simple-search-focus-color, var(--simple-search-text-color, #000000));
        --paper-input-container-color: var(--simple-search-focus-color, var(--simple-search-text-color, #000000));
        --paper-input-container: {
          padding: 0 0;
        };
      }
    </style>
    <paper-input id="input" label="[[label]]">
      <iron-icon icon="search" slot="prefix"></iron-icon>
    </paper-input>
  </template>

  <script>
    Polymer({

      is: 'a11y-media-transcript-search',

      behaviors: [a11yMediaBehaviors.PlayerBehaviors],

      properties: {
        /*
         * label for search box
         */
        label: {
          type: String,
          value: 'search',
        },
        /*
         * an array of search terms
         */
        searchTerms: {
          type: Array,
          value: [],
        },
      },
      ready: function(){
        let root = this, search = root.$.input;
        root._getSearchText(search.value);
        root.addEventListener('change',function(e){
          root._getSearchText(search.value);
          root.fire('search',root);
        });
      },
      /** 
       * gets the tab-index of cues based on whether or not interactive cues are disabled
       */
       _getSearchText: function(find){
        let temp = new Array();
        if(find !== undefined && find !== null) {
          temp = find.split(/[\"\']/gm);
          for (let i=0; i<temp.length;i++){
            temp[i] = temp[i].trim();
            if (temp[i] === '') temp.splice(i,1)
          }
        }
        this.set('searchTerms',temp.slice(0));
      },
      /** 
       * search a string of content for any terms and return an array of results
       */
       findMatches: function(content){
        let root = this, terms = root.searchTerms, results = [
          {
            "matched": false, 
            "text": content
          }
        ], updateResults = function(find){
          for(let i = 0; i<results.length; i++){
            if (results[i].matched === false){
              let regex = new RegExp("\\b"+find+"\\b","gim"), text = results[i].text, start = text.search(regex), end = start+find.length;
              if(start > -1){
                let pre = text.slice(0,start), match = text.slice(start,end), post = text.slice(end,content.length), update = results.splice(i,1,{
                  "matched": false, 
                  "text": pre
                },{
                  "matched": true, 
                  "text": match
                },{
                  "matched": false, 
                  "text": post
                });
              } 
            }
          }
        };
        for (let i=0; i<terms.length;i++){
          updateResults(terms[i]);
        }
        return results;
      },
    });
  </script>
</dom-module>
